name: Simple Jira Approval Repo

on:
  workflow_dispatch:
    inputs:
      repo_name:
        required: true
      repo_description:
        required: false
      private:
        required: true
      port_run_id:
        required: true

jobs:
  main:
    runs-on: ubuntu-latest
    steps:
      # Step 1: Create Jira Ticket (with better error handling)
      - name: Create Jira Ticket
        id: jira
        run: |
          echo "Creating Jira ticket for repo: ${{ inputs.repo_name }}"
          
          RESPONSE=$(curl -s -w "%{http_code}" -X POST \
            "${{ secrets.JIRA_BASE_URL }}/rest/api/3/issue" \
            -u "${{ secrets.JIRA_USER_EMAIL }}:${{ secrets.JIRA_API_TOKEN }}" \
            -H "Content-Type: application/json" \
            -d '{
              "fields": {
                "project": {"key": "SCRUM"},
                "issuetype": {"name": "Task"},
                "summary": "Repo Request: ${{ inputs.repo_name }}",
                "description": {
                  "type": "doc",
                  "version": 1,
                  "content": [{
                    "type": "paragraph",
                    "content": [{
                      "type": "text",
                      "text": "Repository: ${{ inputs.repo_name }}\nTO APPROVE: Move to Done TO REJECT: Move to Rejected"
                    }]
                  }]
                }
              }
            }')
          
          HTTP_CODE=$(echo "$RESPONSE" | tail -n1)
          BODY=$(echo "$RESPONSE" | sed '$d')
          
          echo "HTTP Status: $HTTP_CODE"
          echo "Response: $BODY"
          
          if [ "$HTTP_CODE" -ne 201 ]; then
            echo "‚ùå Failed to create Jira ticket!"
            echo "$BODY" | jq '.'
            exit 1
          fi
          
          KEY=$(echo "$BODY" | jq -r '.key')
          
          if [ -z "$KEY" ] || [ "$KEY" = "null" ]; then
            echo "‚ùå Failed to extract Jira key!"
            exit 1
          fi
          
          echo "key=$KEY" >> $GITHUB_OUTPUT
          echo "‚úÖ Created Jira ticket: $KEY"

      - name: Report Jira Created
        uses: port-labs/port-github-action@v1
        with:
          clientId: ${{ secrets.PORT_CLIENT_ID }}
          clientSecret: ${{ secrets.PORT_CLIENT_SECRET }}
          operation: PATCH_RUN
          runId: ${{ inputs.port_run_id }}
          logMessage: |
            üé´ Jira ticket created: ${{ steps.jira.outputs.key }}
            üîó View: ${{ secrets.JIRA_BASE_URL }}/browse/${{ steps.jira.outputs.key }}
            
            ‚è≥ Waiting for approval...
            ‚úÖ To approve: Move ticket to "Done"
            ‚ùå To reject: Move ticket to "Rejected"
      # Step 2: Wait for Decision
      - name: Wait for Decision
        id: decision
        run: |
          ISSUE_KEY="${{ steps.jira.outputs.key }}"
          
          if [ -z "$ISSUE_KEY" ] || [ "$ISSUE_KEY" = "null" ]; then
            echo "‚ùå No Jira issue key available!"
            exit 1
          fi
          
          echo "Monitoring Jira ticket: $ISSUE_KEY"
          
          for i in {1..30}; do
            RESPONSE=$(curl -s \
              "${{ secrets.JIRA_BASE_URL }}/rest/api/3/issue/$ISSUE_KEY?fields=status" \
              -u "${{ secrets.JIRA_USER_EMAIL }}:${{ secrets.JIRA_API_TOKEN }}")
            
            STATUS=$(echo "$RESPONSE" | jq -r '.fields.status.name')
            
            echo "[$i/30] Status: $STATUS"
            
            # Check for approval
            if [ "$STATUS" = "Done" ]; then
              echo "decision=approved" >> $GITHUB_OUTPUT
              echo "‚úÖ APPROVED!"
              exit 0
            fi
            
            # Check for rejection
            if [ "$STATUS" = "Rejected" ] || [ "$STATUS" = "Cancelled" ]; then
              echo "decision=rejected" >> $GITHUB_OUTPUT
              echo "‚ùå REJECTED!"
              exit 0
            fi
            
            # Check for errors
            if [ "$STATUS" = "null" ]; then
              echo "‚ö†Ô∏è Warning: Could not fetch status (attempt $i/30)"
            fi
            
            sleep 60
          done
          
          # Timeout
          echo "decision=timeout" >> $GITHUB_OUTPUT
          echo "‚è±Ô∏è TIMEOUT - No decision made"
          exit 0

      # Step 3: Create Repo (only if approved)
      - name: Create GitHub Repo
        if: steps.decision.outputs.decision == 'approved'
        id: repo
        run: |
          echo "Creating repository: ${{ inputs.repo_name }}"
          
          RESPONSE=$(curl -s -w "%{http_code}" -X POST \
            -H "Authorization: token ${{ secrets.GH_TOKEN }}" \
            -H "Accept: application/vnd.github.v3+json" \
            https://api.github.com/orgs/abiolaemma2026/repos \
            -d '{
              "name": "${{ inputs.repo_name }}",
              "description": "${{ inputs.repo_description }}",
              "private": ${{ inputs.private }},
              "auto_init": true
            }')
          
          HTTP_CODE=$(echo "$RESPONSE" | tail -n1)
          BODY=$(echo "$RESPONSE" | sed '$d')
          
          if [ "$HTTP_CODE" -ne 201 ]; then
            echo "‚ùå Failed to create repository!"
            echo "$BODY" | jq '.'
            exit 1
          fi
          
          URL=$(echo "$BODY" | jq -r '.html_url')
          echo "url=$URL" >> $GITHUB_OUTPUT
          echo "‚úÖ Created: $URL"

            -H "Authorization: token ${{ secrets.GH_TOKEN }}" \
            -H "Accept: application/vnd.github.v3+json" \
            https://api.github.com/orgs/abiolaemma2026/repos \
            -d '{
              "name": "${{ inputs.repo_name }}",
              "description": "${{ inputs.repo_description }}",
              "private": ${{ inputs.private }},
              "auto_init": true
            }')
          
          HTTP_CODE=$(echo "$RESPONSE" | tail -n1)
          BODY=$(echo "$RESPONSE" | sed '$d')
          
          if [ "$HTTP_CODE" -ne 201 ]; then
            echo "‚ùå Failed to create repository!"
            echo "$BODY" | jq '.'
            exit 1
          fi
          
          URL=$(echo "$BODY" | jq -r '.html_url')
          echo "url=$URL" >> $GITHUB_OUTPUT
          echo "‚úÖ Created: $URL"

      # Step 4: Report Success
      - name: Report Success
        if: steps.decision.outputs.decision == 'approved'
        uses: port-labs/port-github-action@v1
        with:
          clientId: ${{ secrets.PORT_CLIENT_ID }}
          clientSecret: ${{ secrets.PORT_CLIENT_SECRET }}
          operation: PATCH_RUN
          runId: ${{ inputs.port_run_id }}
          logMessage: |
            ‚úÖ Repository created successfully!
            
            üîó Repository: ${{ steps.repo.outputs.url }}
            üé´ Jira ticket: ${{ secrets.JIRA_BASE_URL }}/browse/${{ steps.jira.outputs.key }}

      # Step 5: Report Rejection
      - name: Report Rejection
        if: steps.decision.outputs.decision == 'rejected'
        uses: port-labs/port-github-action@v1
        with:
          clientId: ${{ secrets.PORT_CLIENT_ID }}
          clientSecret: ${{ secrets.PORT_CLIENT_SECRET }}
          operation: PATCH_RUN
          runId: ${{ inputs.port_run_id }}
          status: FAILURE
          logMessage: |
            ‚ùå Repository request was REJECTED
            
            üé´ Jira ticket: ${{ secrets.JIRA_BASE_URL }}/browse/${{ steps.jira.outputs.key }}
            
            No repository was created.

      # Step 6: Report Timeout
      - name: Report Timeout
        if: steps.decision.outputs.decision == 'timeout'
        uses: port-labs/port-github-action@v1
        with:
          clientId: ${{ secrets.PORT_CLIENT_ID }}
          clientSecret: ${{ secrets.PORT_CLIENT_SECRET }}
          operation: PATCH_RUN
          runId: ${{ inputs.port_run_id }}
          status: FAILURE
          logMessage: |
            ‚è±Ô∏è Request timed out - No decision made within 30 minutes
            
            üé´ Jira ticket: ${{ secrets.JIRA_BASE_URL }}/browse/${{ steps.jira.outputs.key }}
            
            No repository was created.
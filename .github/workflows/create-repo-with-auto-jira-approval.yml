name: Simple Jira Approval Repo

on:
  workflow_dispatch:
    inputs:
      repo_name:
        required: true
      repo_description:
        required: false
      private:
        required: true
      port_run_id:
        required: true

jobs:
  main:
    runs-on: ubuntu-latest
    steps:
      # Step 1: Create Jira Ticket
      - name: Create Jira Ticket
        id: jira
        run: |
          RESPONSE=$(curl -s -X POST \
            "${{ secrets.JIRA_BASE_URL }}/rest/api/3/issue" \
            -u "${{ secrets.JIRA_USER_EMAIL }}:${{ secrets.JIRA_API_TOKEN }}" \
            -H "Content-Type: application/json" \
            -d '{
              "fields": {
                "project": {"key": "SCRUM"},
                "issuetype": {"name": "Task"},
                "summary": "Repo Request: ${{ inputs.repo_name }}",
                "description": {
                  "type": "doc",
                  "version": 1,
                  "content": [{
                    "type": "paragraph",
                    "content": [{
                      "type": "text",
                      "text": "Repository: ${{ inputs.repo_name }}\nMove to Done to approve."
                    }]
                  }]
                }
              }
            }')
          
          KEY=$(echo "$RESPONSE" | jq -r '.key')
          echo "key=$KEY" >> $GITHUB_OUTPUT
          echo "Created Jira: $KEY"

      # Step 2: Wait for Approval (checks every minute for 30 minutes)
      - name: Wait for Approval
        run: |
          for i in {1..30}; do
            STATUS=$(curl -s \
              "${{ secrets.JIRA_BASE_URL }}/rest/api/3/issue/${{ steps.jira.outputs.key }}?fields=status" \
              -u "${{ secrets.JIRA_USER_EMAIL }}:${{ secrets.JIRA_API_TOKEN }}" \
              | jq -r '.fields.status.name')
            
            echo "[$i/30] Status: $STATUS"
            
            if [ "$STATUS" = "Done" ]; then
              echo "âœ… Approved!"
              exit 0
            fi
            
            sleep 60
          done
          
          echo "âŒ Timeout - no approval"
          exit 1

      # Step 3: Create GitHub Repo (only runs if approved)
      - name: Create GitHub Repo
        id: repo
        run: |
          curl -X POST \
            -H "Authorization: token ${{ secrets.GH_TOKEN }}" \
            https://api.github.com/orgs/abiolaemma2026/repos \
            -d '{
            "name": "${{ inputs.repo_name }}",
            "description": "${{ inputs.repo_description }}",
            "private": ${{ inputs.private }},
            "auto_init": true
            }' | tee response.json
          
          URL=$(jq -r '.html_url' response.json)
          echo "url=$URL" >> $GITHUB_OUTPUT
          echo "âœ… Created: $URL"

      # Step 4: Report to Port
      - name: Update Port
        uses: port-labs/port-github-action@v1
        with:
          clientId: ${{ secrets.PORT_CLIENT_ID }}
          clientSecret: ${{ secrets.PORT_CLIENT_SECRET }}
          operation: PATCH_RUN
          runId: ${{ inputs.port_run_id }}
          logMessage: |
            âœ… Repository created: ${{ steps.repo.outputs.url }}
            ðŸŽ« Jira ticket: ${{ steps.jira.outputs.key }}
  create-github-repo:
    name: Create GitHub Repository
    runs-on: ubuntu-latest
    needs: create-jira-ticket
    outputs:
      repo_url: ${{ steps.create_repo.outputs.repo_url }}
      repo_full_name: ${{ steps.create_repo.outputs.repo_full_name }}
    
    steps:
      - name: Log to Port - Creating Repository
        uses: port-labs/port-github-action@v1
        with:
          clientId: ${{ secrets.PORT_CLIENT_ID }}
          clientSecret: ${{ secrets.PORT_CLIENT_SECRET }}
          operation: PATCH_RUN
          runId: ${{ fromJson(inputs.port_context).runId }}
          logMessage: |
            üöÄ Step 2/3: Creating GitHub repository...
            üì¶ Repository: ${{ inputs.repo_name }}

      - name: Create GitHub Repository
        id: create_repo
        env:
          GITHUB_TOKEN: ${{ secrets.GH_TOKEN }}
        run: |
          echo "Creating repository: ${{ inputs.repo_name }}"
          
          RESPONSE=$(curl -s -w "
%{http_code}" -X POST \
            -H "Authorization: token $GITHUB_TOKEN" \
            -H "Accept: application/vnd.github+json" \
            -H "X-GitHub-Api-Version: 2022-11-28" \
            https://api.github.com/orgs/abiolaemma2026/repos \
            -d '{
              "name": "${{ inputs.repo_name }}",
              "description": "${{ inputs.description }}",
              "private": ${{ inputs.private }},
              "auto_init": ${{ inputs.auto_init }}
            }')
          
          HTTP_CODE=$(echo "$RESPONSE" | tail -n1)
          BODY=$(echo "$RESPONSE" | sed '$d')
          
          echo "HTTP Status Code: $HTTP_CODE"
          
          if [ "$HTTP_CODE" -ge 200 ] && [ "$HTTP_CODE" -lt 300 ]; then
            echo "‚úÖ Repository created successfully!"
            REPO_URL=$(echo "$BODY" | jq -r '.html_url')
            REPO_FULL_NAME=$(echo "$BODY" | jq -r '.full_name')
            echo "Repository URL: $REPO_URL"
            echo "repo_url=$REPO_URL" >> $GITHUB_OUTPUT
            echo "repo_full_name=$REPO_FULL_NAME" >> $GITHUB_OUTPUT
          else
            echo "‚ùå Failed to create repository (HTTP $HTTP_CODE)"
            echo "Response body:"
            echo "$BODY" | jq '.' || echo "$BODY"
            exit 1
          fi

      - name: Log Success to Port
        uses: port-labs/port-github-action@v1
        with:
          clientId: ${{ secrets.PORT_CLIENT_ID }}
          clientSecret: ${{ secrets.PORT_CLIENT_SECRET }}
          operation: PATCH_RUN
          runId: ${{ fromJson(inputs.port_context).runId }}
          link: ${{ steps.create_repo.outputs.repo_url }}
          logMessage: |
            ‚úÖ GitHub repository created successfully!
            üîó Repository: ${{ steps.create_repo.outputs.repo_url }}
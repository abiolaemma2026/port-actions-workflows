name: Create Repo with Jira Approval

on:
  workflow_dispatch:
    inputs:
      jira_issue_key:
        required: true
        type: string
      repo_name:
        required: true
        type: string
      port_run_id:
        required: false
        type: string

jobs:
  wait-and-create:
    runs-on: ubuntu-latest
    steps:
      - name: Wait for Jira Approval
        id: wait
        run: |
          for i in {1..60}; do
            STATUS=$(curl -s -u "${{ secrets.JIRA_EMAIL }}:${{ secrets.JIRA_API_TOKEN }}" \
              "${{ secrets.JIRA_BASE_URL }}/rest/api/3/issue/${{ inputs.jira_issue_key }}" \
              | jq -r '.fields.status.name')
            
            echo "Check $i: Status = $STATUS"
            
            if [[ "$STATUS" == "Done" ]]; then
              echo "approved=true" >> $GITHUB_OUTPUT
              exit 0
            elif [[ "$STATUS" == "Rejected" ]]; then
              echo "approved=false" >> $GITHUB_OUTPUT
              exit 0
            fi
            
            sleep 30
          done
          
          echo "Timeout"
          exit 1

      - name: Create Repo
        if: steps.wait.outputs.approved == 'true'
        run: |
          curl -X POST \
            -H "Authorization: token ${{ secrets.GH_TOKEN }}" \
            -H "Accept: application/vnd.github.v3+json" \
            https://api.github.com/orgs/abiolaemma2026/repos \
            -d '{"name":"${{ inputs.repo_name }}","private":false,"auto_init":true}'

      - name: Report to Port
        if: always() && inputs.port_run_id != ''
        run: |
          TOKEN=$(curl -s -X POST https://api.getport.io/v1/auth/access_token \
            -H "Content-Type: application/json" \
            -d '{"clientId":"${{ secrets.PORT_CLIENT_ID }}","clientSecret":"${{ secrets.PORT_CLIENT_SECRET }}"}' \
            | jq -r '.accessToken')
          
          if [ "${{ steps.wait.outputs.approved }}" == "true" ]; then
            MSG="✅ Approved and created"
            STATUS="SUCCESS"
          else
            MSG="❌ Rejected"
            STATUS="FAILURE"
          fi
          
          curl -X PATCH \
            -H "Authorization: Bearer $TOKEN" \
            -H "Content-Type: application/json" \
            -d "{\"status\":\"$STATUS\",\"message\":\"$MSG\"}" \
            "https://api.getport.io/v1/actions/runs/${{ inputs.port_run_id }}"
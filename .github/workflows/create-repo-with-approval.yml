name: Create GitHub Repo with Jira Tracking (Approved)

on:
  workflow_dispatch:
    inputs:
      repo_name:
        required: true
        type: string
        description: "Name of the repository to create"
      description:
        required: false
        type: string
        default: "Created via Port.io with approval"
      private:
        required: false
        type: boolean
        default: false
      auto_init:
        required: false
        type: boolean
        default: true
      port_context:
        required: true
        type: string
        description: "Port context (JSON string)"

jobs:
  create-jira-ticket:
    name: Create Jira Tracking Ticket
    runs-on: ubuntu-latest
    outputs:
      jira_issue_key: ${{ steps.create_jira.outputs.issue_key }}
    
    steps:
      - name: Log to Port - Starting Process
        uses: port-labs/port-github-action@v1
        with:
          clientId: ${{ secrets.PORT_CLIENT_ID }}
          clientSecret: ${{ secrets.PORT_CLIENT_SECRET }}
          operation: PATCH_RUN
          runId: ${{ fromJson(github.event.inputs.port_context).runId }}
          logMessage: |
            üéâ Request approved! Starting repository creation process...
            üìù Step 1/3: Creating Jira tracking ticket

      - name: Create Jira Issue
        id: create_jira
        env:
          JIRA_BASE_URL: ${{ secrets.JIRA_BASE_URL }}
          JIRA_USER_EMAIL: ${{ secrets.JIRA_USER_EMAIL }}
          JIRA_API_TOKEN: ${{ secrets.JIRA_API_TOKEN }}
          JIRA_PROJECT_KEY: ${{ secrets.JIRA_PROJECT_KEY }}
        run: |
          echo "Creating Jira ticket for repository: ${{ github.event.inputs.repo_name }}"
          
          RESPONSE=$(curl -s -X POST \
            -H "Content-Type: application/json" \
            -u "$JIRA_USER_EMAIL:$JIRA_API_TOKEN" \
            "$JIRA_BASE_URL/rest/api/3/issue" \
            -d '{
              "fields": {
                "project": {
                  "key": "'"$JIRA_PROJECT_KEY"'"
                },
                "summary": "GitHub Repository Created: ${{ github.event.inputs.repo_name }}",
                "description": {
                  "type": "doc",
                  "version": 1,
                  "content": [
                    {
                      "type": "heading",
                      "attrs": {"level": 2},
                      "content": [
                        {
                          "type": "text",
                          "text": "Repository Details"
                        }
                      ]
                    },
                    {
                      "type": "bulletList",
                      "content": [
                        {
                          "type": "listItem",
                          "content": [
                            {
                              "type": "paragraph",
                              "content": [
                                {
                                  "type": "text",
                                  "text": "Repository Name: ",
                                  "marks": [{"type": "strong"}]
                                },
                                {
                                  "type": "text",
                                  "text": "${{ github.event.inputs.repo_name }}"
                                }
                              ]
                            }
                          ]
                        },
                        {
                          "type": "listItem",
                          "content": [
                            {
                              "type": "paragraph",
                              "content": [
                                {
                                  "type": "text",
                                  "text": "Description: ",
                                  "marks": [{"type": "strong"}]
                                },
                                {
                                  "type": "text",
                                  "text": "${{ github.event.inputs.description }}"
                                }
                              ]
                            }
                          ]
                        },
                        {
                          "type": "listItem",
                          "content": [
                            {
                              "type": "paragraph",
                              "content": [
                                {
                                  "type": "text",
                                  "text": "Private: ",
                                  "marks": [{"type": "strong"}]
                                },
                                {
                                  "type": "text",
                                  "text": "${{ github.event.inputs.private }}"
                                }
                              ]
                            }
                          ]
                        },
                        {
                          "type": "listItem",
                          "content": [
                            {
                              "type": "paragraph",
                              "content": [
                                {
                                  "type": "text",
                                  "text": "Auto Initialize: ",
                                  "marks": [{"type": "strong"}]
                                },
                                {
                                  "type": "text",
                                  "text": "${{ github.event.inputs.auto_init }}"
                                }
                              ]
                            }
                          ]
                        },
                        {
                          "type": "listItem",
                          "content": [
                            {
                              "type": "paragraph",
                              "content": [
                                {
                                  "type": "text",
                                  "text": "Requested By: ",
                                  "marks": [{"type": "strong"}]
                                },
                                {
                                  "type": "text",
                                  "text": "${{ fromJson(github.event.inputs.port_context).user }}"
                                }
                              ]
                            }
                          ]
                        }
                      ]
                    },
                    {
                      "type": "paragraph",
                      "content": [
                        {
                          "type": "text",
                          "text": "This ticket was automatically created after approval in Port.io",
                          "marks": [{"type": "em"}]
                        }
                      ]
                    }
                  ]
                },
                "issuetype": {
                  "name": "Task"
                },
                "labels": ["github-repo", "port-automation", "approved"]
              }
            }')
          
          # Extract issue key
          ISSUE_KEY=$(echo "$RESPONSE" | jq -r '.key // empty')
          
          if [ -n "$ISSUE_KEY" ] && [ "$ISSUE_KEY" != "null" ]; then
            echo "‚úÖ Jira ticket created successfully: $ISSUE_KEY"
            echo "issue_key=$ISSUE_KEY" >> $GITHUB_OUTPUT
          else
            echo "‚ö†Ô∏è Failed to create Jira ticket, but continuing..."
            echo "Response: $RESPONSE"
            echo "issue_key=JIRA-CREATION-FAILED" >> $GITHUB_OUTPUT
          fi

      - name: Log Jira Ticket to Port
        if: steps.create_jira.outputs.issue_key != 'JIRA-CREATION-FAILED'
        uses: port-labs/port-github-action@v1
        with:
          clientId: ${{ secrets.PORT_CLIENT_ID }}
          clientSecret: ${{ secrets.PORT_CLIENT_SECRET }}
          operation: PATCH_RUN
          runId: ${{ fromJson(github.event.inputs.port_context).runId }}
          link: ${{ secrets.JIRA_BASE_URL }}/browse/${{ steps.create_jira.outputs.issue_key }}
          logMessage: |
            ‚úÖ Jira tracking ticket created: ${{ steps.create_jira.outputs.issue_key }}
            üîó View ticket: ${{ secrets.JIRA_BASE_URL }}/browse/${{ steps.create_jira.outputs.issue_key }}

  create-github-repo:
    name: Create GitHub Repository
    runs-on: ubuntu-latest
    needs: create-jira-ticket
    outputs:
      repo_url: ${{ steps.create_repo.outputs.repo_url }}
      repo_full_name: ${{ steps.create_repo.outputs.repo_full_name }}
    
    steps:
      - name: Log to Port - Creating Repository
        uses: port-labs/port-github-action@v1
        with:
          clientId: ${{ secrets.PORT_CLIENT_ID }}
          clientSecret: ${{ secrets.PORT_CLIENT_SECRET }}
          operation: PATCH_RUN
          runId: ${{ fromJson(github.event.inputs.port_context).runId }}
          logMessage: |
            üöÄ Step 2/3: Creating GitHub repository...
            üì¶ Repository: ${{ github.event.inputs.repo_name }}

      - name: Create GitHub Repository
        id: create_repo
        env:
          GITHUB_TOKEN: ${{ secrets.GH_TOKEN }}
        run: |
          echo "Creating repository: ${{ github.event.inputs.repo_name }}"
          
          RESPONSE=$(curl -s -w "%{http_code}" -X POST \
            -H "Authorization: token $GITHUB_TOKEN" \
            -H "Accept: application/vnd.github+json" \
            -H "X-GitHub-Api-Version: 2022-11-28" \
            https://api.github.com/orgs/abiolaemma2026/repos \
            -d '{
              "name": "${{ github.event.inputs.repo_name }}",
              "description": "${{ github.event.inputs.description }}",
              "private": ${{ github.event.inputs.private }},
              "auto_init": ${{ github.event.inputs.auto_init }}
            }')
          
          HTTP_CODE=$(echo "$RESPONSE" | tail -n1)
          BODY=$(echo "$RESPONSE" | sed '$d')
          
          echo "HTTP Status Code: $HTTP_CODE"
          
          if [ "$HTTP_CODE" -ge 200 ] && [ "$HTTP_CODE" -lt 300 ]; then
            echo "‚úÖ Repository created successfully!"
            REPO_URL=$(echo "$BODY" | jq -r '.html_url')
            REPO_FULL_NAME=$(echo "$BODY" | jq -r '.full_name')
            echo "Repository URL: $REPO_URL"
            echo "repo_url=$REPO_URL" >> $GITHUB_OUTPUT
            echo "repo_full_name=$REPO_FULL_NAME" >> $GITHUB_OUTPUT
          else
            echo "‚ùå Failed to create repository (HTTP $HTTP_CODE)"
            echo "Response body:"
            echo "$BODY" | jq '.' || echo "$BODY"
            exit 1
          fi

      - name: Log Success to Port
        uses: port-labs/port-github-action@v1
        with:
          clientId: ${{ secrets.PORT_CLIENT_ID }}
          clientSecret: ${{ secrets.PORT_CLIENT_SECRET }}
          operation: PATCH_RUN
          runId: ${{ fromJson(github.event.inputs.port_context).runId }}
          link: ${{ steps.create_repo.outputs.repo_url }}
          logMessage: |
            ‚úÖ GitHub repository created successfully!
            üîó Repository: ${{ steps.create_repo.outputs.repo_url }}

  update-port-catalog:
    name: Update Port Catalog
    runs-on: ubuntu-latest
    needs: [create-jira-ticket, create-github-repo]
    
    steps:
      - name: Log to Port - Updating Catalog
        uses: port-labs/port-github-action@v1
        with:
          clientId: ${{ secrets.PORT_CLIENT_ID }}
          clientSecret: ${{ secrets.PORT_CLIENT_SECRET }}
          operation: PATCH_RUN
          runId: ${{ fromJson(github.event.inputs.port_context).runId }}
          logMessage: |
            üìä Step 3/3: Updating Port catalog...

      - name: Create/Update Port Entity
        uses: port-labs/port-github-action@v1
        with:
          clientId: ${{ secrets.PORT_CLIENT_ID }}
          clientSecret: ${{ secrets.PORT_CLIENT_SECRET }}
          operation: UPSERT
          identifier: ${{ github.event.inputs.repo_name }}
          blueprint: githubRepository
          properties: |
            {
              "name": "${{ github.event.inputs.repo_name }}",
              "description": "${{ github.event.inputs.description }}",
              "url": "${{ needs.create-github-repo.outputs.repo_url }}"
            }
          relations: |
            {
              "jira_approval_ticket": "${{ needs.create-jira-ticket.outputs.jira_issue_key }}"
            }

      - name: Final Success Log
        uses: port-labs/port-github-action@v1
        with:
          clientId: ${{ secrets.PORT_CLIENT_ID }}
          clientSecret: ${{ secrets.PORT_CLIENT_SECRET }}
          operation: PATCH_RUN
          runId: ${{ fromJson(github.event.inputs.port_context).runId }}
          logMessage: |
            üéâ All done! Repository creation completed successfully!
            
            ‚úÖ Jira Ticket: ${{ needs.create-jira-ticket.outputs.jira_issue_key }}
            ‚úÖ GitHub Repo: ${{ needs.create-github-repo.outputs.repo_url }}
            ‚úÖ Port Entity: Updated
            
            Your new repository is ready to use! üöÄ